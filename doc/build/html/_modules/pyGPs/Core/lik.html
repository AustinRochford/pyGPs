<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyGPs.Core.lik &mdash; pyGPs v1.3 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     'v1.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="pyGPs v1.3 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pyGPs v1.3 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyGPs.Core.lik</h1><div class="highlight"><pre>
<span class="c">#    Marion Neumann [marion dot neumann at uni-bonn dot de]</span>
<span class="c">#    Daniel Marthaler [marthaler at ge dot com]</span>
<span class="c">#    Shan Huang [shan dot huang at iais dot fraunhofer dot de]</span>
<span class="c">#    Kristian Kersting [kristian dot kersting at cs dot tu-dortmund dot de]</span>
<span class="c">#</span>
<span class="c">#    This file is part of pyGPs.</span>
<span class="c">#    The software package is released under the BSD 2-Clause (FreeBSD) License.</span>
<span class="c">#</span>
<span class="c">#    Copyright (c) by</span>
<span class="c">#    Marion Neumann, Daniel Marthaler, Shan Huang &amp; Kristian Kersting, 18/02/2014</span>
<span class="c">#================================================================================</span>

<span class="c"># likelihood functions are provided to be used by the gp.py function:</span>
<span class="c">#</span>
<span class="c">#   Erf         (Error function, classification, probit regression)</span>
<span class="c">#   Logistic    [NOT IMPLEMENTED!] (Logistic, classification, logit regression)</span>
<span class="c">#   Uni         [NOT IMPLEMENTED!] (Uniform likelihood, classification)</span>
<span class="c">#</span>
<span class="c">#   Gauss       (Gaussian, regression)</span>
<span class="c">#   Laplace     (Laplacian or double exponential, regression)</span>
<span class="c">#   Sech2       [NOT IMPLEMENTED!] (Sech-square, regression)</span>
<span class="c">#   T           [NOT IMPLEMENTED!] (Student&#39;s t, regression)</span>
<span class="c">#</span>
<span class="c">#   Poisson     [NOT IMPLEMENTED!] (Poisson regression, count data)</span>
<span class="c">#</span>
<span class="c">#   Mix         [NOT IMPLEMENTED!] (Mixture of individual covariance functions)</span>
<span class="c">#</span>
<span class="c"># See the documentation for the individual likelihood for the computations specific </span>
<span class="c"># to each likelihood function.</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># This is a object-oriented python implementation of gpml functionality </span>
<span class="c"># (Copyright (c) by Carl Edward Rasmussen and Hannes Nickisch, 2011-02-18).</span>
<span class="c"># based on the functional-version of python implementation</span>
<span class="c"># (Copyright (c) by Marion Neumann and Daniel Marthaler, 20/05/2013)</span>
<span class="c"># </span>
<span class="c"># Copyright (c) by Marion Neumann and Shan Huang, 30/09/2013</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erf</span>
<span class="kn">import</span> <span class="nn">inf</span>

<span class="k">class</span> <span class="nc">Likelihood</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base function for Likelihood function&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">proceed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">s2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inffunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The likelihood functions have two possible modes, the mode being selected</span>
<span class="sd">        as follows (where &quot;lik&quot; stands for &quot;proceed&quot; method for any likelihood function):</span>


<span class="sd">        1) With two or three input arguments:                       [PREDICTION MODE]</span>

<span class="sd">         lp = lik(y, mu) OR lp, ymu, ys2 = lik(y, mu, s2)</span>

<span class="sd">            This allows to evaluate the predictive distribution. Let p(y_*|f_*) be the</span>
<span class="sd">            likelihood of a test point and N(f_*|mu,s2) an approximation to the posterior</span>
<span class="sd">            marginal p(f_*|x_*,x,y) as returned by an inference method. The predictive</span>
<span class="sd">            distribution p(y_*|x_*,x,y) is approximated by:</span>
<span class="sd">            q(y_*) = \int N(f_*|mu,s2) p(y_*|f_*) df_*</span>

<span class="sd">            lp = log( q(y) ) for a particular value of y, if s2 is [] or 0, this</span>
<span class="sd">            corresponds to log( p(y|mu) ).</span>
<span class="sd">            </span>
<span class="sd">            ymu and ys2 are the mean and variance of the predictive marginal q(y)</span>
<span class="sd">            note that these two numbers do not depend on a particular </span>
<span class="sd">            value of y.</span>
<span class="sd">            All vectors have the same size.</span>


<span class="sd">        2) With four or five input arguments, the fouth being an object of class &quot;Inference&quot; [INFERENCE MODE]</span>

<span class="sd">         lik(y, mu, s2, inf) OR lik(y, mu, s2, inf, i)</span>

<span class="sd">         There are two cases for inf, namely a) infLaplace, b) infEP </span>
<span class="sd">         The last input i, refers to derivatives w.r.t. the ith hyperparameter. </span>

<span class="sd">         | a1) </span>
<span class="sd">         | lp,dlp,d2lp,d3lp = lik(y, f, [], &#39;infLaplace&#39;). </span>
<span class="sd">         | lp, dlp, d2lp and d3lp correspond to derivatives of the log likelihood. </span>
<span class="sd">         | log(p(y|f)) w.r.t. to the latent location f.</span>
<span class="sd">         | lp = log( p(y|f) ) </span>
<span class="sd">         | dlp = d log( p(y|f) ) / df </span>
<span class="sd">         | d2lp = d^2 log( p(y|f) ) / df^2</span>
<span class="sd">         | d3lp = d^3 log( p(y|f) ) / df^3 </span>

<span class="sd">         | a2)</span>
<span class="sd">         | lp_dhyp,dlp_dhyp,d2lp_dhyp = lik(y, f, [], &#39;infLaplace&#39;, i) </span>
<span class="sd">         | returns derivatives w.r.t. to the ith hyperparameter </span>
<span class="sd">         | lp_dhyp = d log( p(y|f) ) / (dhyp_i) </span>
<span class="sd">         | dlp_dhyp = d^2 log( p(y|f) ) / (df   dhyp_i) </span>
<span class="sd">         | d2lp_dhyp = d^3 log( p(y|f) ) / (df^2 dhyp_i) </span>


<span class="sd">         | b1)</span>
<span class="sd">         | lZ,dlZ,d2lZ = lik(y, mu, s2, &#39;infEP&#39;) </span>
<span class="sd">         | let Z = \int p(y|f) N(f|mu,s2) df then </span>
<span class="sd">         | lZ = log(Z) </span>
<span class="sd">         | dlZ = d log(Z) / dmu </span>
<span class="sd">         | d2lZ = d^2 log(Z) / dmu^2 </span>

<span class="sd">         | b2)</span>
<span class="sd">         | dlZhyp = lik(y, mu, s2, &#39;infEP&#39;, i)</span>
<span class="sd">         | returns derivatives w.r.t. to the ith hyperparameter </span>
<span class="sd">         | dlZhyp = d log(Z) / dhyp_i </span>

<span class="sd">        Cumulative likelihoods are designed for binary classification. Therefore, they</span>
<span class="sd">        only look at the sign of the targets y; zero values are treated as +1.</span>

<span class="sd">        Some examples for valid likelihood functions:</span>
<span class="sd">         | lik = likGauss([0.1])</span>
<span class="sd">         | lik = likErf()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="Gauss"><a class="viewcode-back" href="../../../Default.html#pyGPs.Core.lik.Gauss">[docs]</a><span class="k">class</span> <span class="nc">Gauss</span><span class="p">(</span><span class="n">Likelihood</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Gaussian likelihood function for regression. </span>

<span class="sd">    :math:`Gauss(t)=\\frac{1}{\\sqrt{2\\pi\\sigma^2}}e^{-\\frac{(t-y)^2}{2\\sigma^2}}`,</span>
<span class="sd">    where :math:`y` is the mean and :math:`\\sigma` is the standard deviation.</span>

<span class="sd">    hyp = [ log_sigma ]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span> <span class="o">=</span> <span class="p">[</span><span class="n">log_sigma</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">proceed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">s2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inffunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">sn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">inffunc</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>              <span class="c"># prediction mode </span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">s2zero</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s2</span><span class="o">==</span><span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s2zero</span> <span class="o">=</span> <span class="bp">False</span>     
            <span class="k">if</span> <span class="n">s2zero</span><span class="p">:</span>                   <span class="c"># log probability</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="n">sn2</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">sn2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> 
                <span class="n">s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inf_func</span> <span class="o">=</span> <span class="n">inf</span><span class="o">.</span><span class="n">EP</span><span class="p">()</span>   <span class="c"># prediction</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">inf_func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ymu</span> <span class="o">=</span> <span class="n">mu</span>                 <span class="c"># first y moment</span>
                <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">ys2</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">+</span> <span class="n">sn2</span>       <span class="c"># second y moment</span>
                    <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">ymu</span><span class="p">,</span><span class="n">ys2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">ymu</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lp</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inffunc</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">EP</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>                                  <span class="c"># no derivative mode</span>
                    <span class="n">lZ</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">sn2</span><span class="o">+</span><span class="n">s2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">sn2</span><span class="o">+</span><span class="n">s2</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span> <span class="c"># log part function</span>
                    <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">dlZ</span>  <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sn2</span><span class="o">+</span><span class="n">s2</span><span class="p">)</span>                   <span class="c"># 1st derivative w.r.t. mean</span>
                        <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                            <span class="n">d2lZ</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">sn2</span><span class="o">+</span><span class="n">s2</span><span class="p">)</span>                   <span class="c"># 2nd derivative w.r.t. mean</span>
                            <span class="k">return</span> <span class="n">lZ</span><span class="p">,</span><span class="n">dlZ</span><span class="p">,</span><span class="n">d2lZ</span>
                        <span class="k">else</span><span class="p">:</span>
                           <span class="k">return</span> <span class="n">lZ</span><span class="p">,</span><span class="n">dlZ</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">lZ</span>
                <span class="k">else</span><span class="p">:</span>                                            <span class="c"># derivative mode</span>
                    <span class="n">dlZhyp</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">sn2</span><span class="o">+</span><span class="n">s2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">s2</span><span class="o">/</span><span class="n">sn2</span><span class="p">)</span> <span class="c"># deriv. w.r.t. hyp.lik</span>
                    <span class="k">return</span> <span class="n">dlZhyp</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inffunc</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">Laplace</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>                                  <span class="c"># no derivative mode</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> 
                        <span class="n">y</span><span class="o">=</span><span class="mi">0</span> 
                    <span class="n">ymmu</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">mu</span>
                    <span class="n">lp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ymmu</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sn2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">sn2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> 
                    <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">dlp</span> <span class="o">=</span> <span class="n">ymmu</span><span class="o">/</span><span class="n">sn2</span>                           <span class="c"># dlp, derivative of log likelihood</span>
                        <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>                            <span class="c"># d2lp, 2nd derivative of log likelihood</span>
                            <span class="n">d2lp</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ymmu</span><span class="p">)</span><span class="o">/</span><span class="n">sn2</span>
                            <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>                        <span class="c"># d3lp, 3rd derivative of log likelihood</span>
                                <span class="n">d3lp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ymmu</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span><span class="p">,</span><span class="n">d2lp</span><span class="p">,</span><span class="n">d3lp</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span><span class="p">,</span><span class="n">d2lp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">lp</span>
                <span class="k">else</span><span class="p">:</span>                                            <span class="c"># derivative mode</span>
                    <span class="n">lp_dhyp</span>   <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sn2</span> <span class="o">-</span> <span class="mi">1</span>                <span class="c"># derivative of log likelihood w.r.t. hypers</span>
                    <span class="n">dlp_dhyp</span>  <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">mu</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">sn2</span>                     <span class="c"># first derivative,</span>
                    <span class="n">d2lp_dhyp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sn2</span>           <span class="c"># and also of the second mu derivative</span>
                    <span class="k">return</span> <span class="n">lp_dhyp</span><span class="p">,</span><span class="n">dlp_dhyp</span><span class="p">,</span><span class="n">d2lp_dhyp</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            elif isinstance(inffunc, infVB):</span>
<span class="sd">                if der == None:</span>
<span class="sd">                    # variational lower site bound</span>
<span class="sd">                    # t(s) = exp(-(y-s)^2/2sn2)/sqrt(2*pi*sn2)</span>
<span class="sd">                    # the bound has the form: b*s - s.^2/(2*ga) - h(ga)/2 with b=y/ga</span>
<span class="sd">                    ga  = s2</span>
<span class="sd">                    n   = len(ga)</span>
<span class="sd">                    b   = y/ga</span>
<span class="sd">                    y   = y*np.ones((n,1))</span>
<span class="sd">                    db  = -y/ga**2 </span>
<span class="sd">                    d2b = 2*y/ga**3</span>
<span class="sd">                    h   = np.zeros((n,1))</span>
<span class="sd">                    dh  = h</span>
<span class="sd">                    d2h = h                           # allocate memory for return args</span>
<span class="sd">                    id  = (ga &lt;= sn2 + 1e-8)          # OK below noise variance</span>
<span class="sd">                    h[id]   = y[id]**2/ga[id] + np.log(2*np.pi*sn2)</span>
<span class="sd">                    h[np.logical_not(id)] = np.inf</span>
<span class="sd">                    dh[id]  = -y[id]**2/ga[id]**2</span>
<span class="sd">                    d2h[id] = 2*y[id]**2/ga[id]**3</span>
<span class="sd">                    id = ga &lt; 0</span>
<span class="sd">                    h[id] = np.inf</span>
<span class="sd">                    dh[id] = 0</span>
<span class="sd">                    d2h[id] = 0                       # neg. var. treatment</span>
<span class="sd">                    varargout = [h,b,dh,db,d2h,d2b]</span>
<span class="sd">                else:</span>
<span class="sd">                    ga = s2 </span>
<span class="sd">                    n  = len(ga)</span>
<span class="sd">                    dhhyp = np.zeros((n,1))</span>
<span class="sd">                    dhhyp[ga&lt;=sn2] = 2</span>
<span class="sd">                    dhhyp[ga&lt;0] = 0                   # negative variances get a special treatment</span>
<span class="sd">                    varargout = dhhyp                 # deriv. w.r.t. hyp.lik</span>
<span class="sd">            else:</span>
<span class="sd">                raise Exception(&#39;Incorrect inference in lik.Gauss\n&#39;)</span>
<span class="sd">        &#39;&#39;&#39;</span>

</div>
<div class="viewcode-block" id="Erf"><a class="viewcode-back" href="../../../Default.html#pyGPs.Core.lik.Erf">[docs]</a><span class="k">class</span> <span class="nc">Erf</span><span class="p">(</span><span class="n">Likelihood</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Error function or cumulative Gaussian likelihood function for binary</span>
<span class="sd">    classification or probit regression. </span>

<span class="sd">    :math:`Erf(t)=\\frac{1}{2}(1+erf(\\frac{t}{\\sqrt{2}}))=normcdf(t)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">proceed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">s2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inffunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">y</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>                                        <span class="c"># allow only +/- 1 values</span>
        <span class="k">if</span> <span class="n">inffunc</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>                              <span class="c"># prediction mode if inf is not present</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>                       <span class="c"># make y a vector</span>
            <span class="n">s2zero</span> <span class="o">=</span> <span class="bp">True</span><span class="p">;</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s2</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">s2zero</span> <span class="o">=</span> <span class="bp">False</span>                       <span class="c"># s2==0?       </span>
            <span class="k">if</span> <span class="n">s2zero</span><span class="p">:</span>                                   <span class="c"># log probability evaluation</span>
                <span class="n">p</span><span class="p">,</span><span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumGauss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                                        <span class="c"># prediction</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">EP</span><span class="p">())</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ymu</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span>                              <span class="c"># first y moment</span>
                <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">ys2</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>                      <span class="c"># second y moment</span>
                    <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">ymu</span><span class="p">,</span><span class="n">ys2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">ymu</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lp</span>
        <span class="k">else</span><span class="p">:</span>                                            <span class="c"># inference mode</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inffunc</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">Laplace</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>                          <span class="c"># no derivative mode</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">mu</span><span class="p">;</span> <span class="n">yf</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">f</span>                     <span class="c"># product latents and labels</span>
                    <span class="n">p</span><span class="p">,</span><span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumGauss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>                        <span class="c"># derivative of log likelihood</span>
                        <span class="n">n_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauOverCumGauss</span><span class="p">(</span><span class="n">yf</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                        <span class="n">dlp</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">n_p</span>                      <span class="c"># derivative of log likelihood</span>
                        <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>                    <span class="c"># 2nd derivative of log likelihood</span>
                            <span class="n">d2lp</span> <span class="o">=</span> <span class="o">-</span><span class="n">n_p</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">yf</span><span class="o">*</span><span class="n">n_p</span>
                            <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>                <span class="c"># 3rd derivative of log likelihood</span>
                                <span class="n">d3lp</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">n_p</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">f</span><span class="o">*</span><span class="n">n_p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n_p</span> 
                                <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span><span class="p">,</span><span class="n">d2lp</span><span class="p">,</span><span class="n">d3lp</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span><span class="p">,</span><span class="n">d2lp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">lp</span>
                <span class="k">else</span><span class="p">:</span>                                    <span class="c"># derivative mode</span>
                    <span class="k">return</span> <span class="p">[]</span>                            <span class="c"># derivative w.r.t. hypers</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inffunc</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">EP</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>                          <span class="c"># no derivative mode</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">mu</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">s2</span><span class="p">)</span> 
                    <span class="n">junk</span><span class="p">,</span><span class="n">lZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cumGauss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>       <span class="c"># log part function</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                         <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">y</span>
                    <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">n_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gauOverCumGauss</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lZ</span><span class="p">))</span>
                        <span class="n">dlZ</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">n_p</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s2</span><span class="p">)</span>       <span class="c"># 1st derivative wrt mean</span>
                        <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                            <span class="n">d2lZ</span> <span class="o">=</span> <span class="o">-</span><span class="n">n_p</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">+</span><span class="n">n_p</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">s2</span><span class="p">)</span>  <span class="c"># 2nd derivative wrt mean</span>
                            <span class="k">return</span> <span class="n">lZ</span><span class="p">,</span><span class="n">dlZ</span><span class="p">,</span><span class="n">d2lZ</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">lZ</span><span class="p">,</span><span class="n">dlZ</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">lZ</span>
                <span class="k">else</span><span class="p">:</span>                                    <span class="c"># derivative mode</span>
                    <span class="k">return</span> <span class="p">[]</span>                       <span class="c"># deriv. wrt hyp.lik</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if inffunc == &#39;inf.infVB&#39;:</span>
<span class="sd">            if der == None:                              # no derivative mode</span>
<span class="sd">                # naive variational lower bound based on asymptotical properties of lik</span>
<span class="sd">                # normcdf(t) -&gt; -(t*A_hat^2-2dt+c)/2 for t-&gt;-np.inf (tight lower bound)</span>
<span class="sd">                d =  0.158482605320942;</span>
<span class="sd">                c = -1.785873318175113;</span>
<span class="sd">                ga = s2; n = len(ga); b = d*y*np.ones((n,1)); db = np.zeros((n,1)); d2b = db</span>
<span class="sd">                h = -2.*c*np.ones((n,1)); h[ga&gt;1] = np.inf; dh = np.zeros((n,1)); d2h = dh   </span>
<span class="sd">                varargout = [h,b,dh,db,d2h,d2b]</span>
<span class="sd">            else:                                        # derivative mode</span>
<span class="sd">                varargout = []                           # deriv. wrt hyp.lik</span>
<span class="sd">        &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">cumGauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c"># return [p,lp] = cumGauss(y,f)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> 
            <span class="n">yf</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">f</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yf</span> <span class="o">=</span> <span class="n">f</span> 
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">erf</span><span class="p">(</span><span class="n">yf</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span><span class="o">/</span><span class="mf">2.</span> <span class="c"># likelihood</span>
        <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> 
            <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logphi</span><span class="p">(</span><span class="n">yf</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="n">lp</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">gauOverCumGauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
        <span class="c"># return n_p = gauOverCumGauss(f,p)</span>
        <span class="n">n_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>       <span class="c"># safely compute Gaussian over cumulative Gaussian</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">f</span><span class="o">&gt;-</span><span class="mi">5</span>                    <span class="c"># naive evaluation for large values of f</span>
        <span class="n">n_p</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">f</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> 
        <span class="n">bd</span> <span class="o">=</span> <span class="n">f</span><span class="o">&lt;-</span><span class="mi">6</span>                    <span class="c"># tight upper bound evaluation</span>
        <span class="n">n_p</span><span class="p">[</span><span class="n">bd</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">bd</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">f</span><span class="p">[</span><span class="n">bd</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ok</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span> <span class="c"># linearly interpolate between both of them</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.</span> <span class="o">-</span> <span class="n">f</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span>
        <span class="n">n_p</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tmp</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">/</span><span class="n">p</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">+</span> <span class="n">lam</span> <span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tmp</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">tmp</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">n_p</span>

    <span class="k">def</span> <span class="nf">logphi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
        <span class="c"># return lp = logphi(z,p)</span>
        <span class="n">lp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>                       <span class="c"># allocate memory</span>
        <span class="n">zmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.2</span><span class="p">;</span> <span class="n">zmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.5</span><span class="p">;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">z</span><span class="o">&gt;</span><span class="n">zmax</span>                                 <span class="c"># safe evaluation for large values</span>
        <span class="n">bd</span> <span class="o">=</span> <span class="n">z</span><span class="o">&lt;</span><span class="n">zmin</span>                                 <span class="c"># use asymptotics</span>
        <span class="n">nok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">nok</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span> <span class="c"># interpolate between both of them</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mf">25.</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zmax</span><span class="o">-</span><span class="n">zmin</span><span class="p">))</span> <span class="p">))</span>  <span class="c"># interp. weights</span>
        <span class="n">lp</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span>
        <span class="n">lp</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">lp</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="n">lp</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">+</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">p</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">lp</span>


</div>
<div class="viewcode-block" id="Laplace"><a class="viewcode-back" href="../../../Default.html#pyGPs.Core.lik.Laplace">[docs]</a><span class="k">class</span> <span class="nc">Laplace</span><span class="p">(</span><span class="n">Likelihood</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    Laplacian likelihood function for regression. ONLY works with EP inference!</span>

<span class="sd">    :math:`Laplace(t) = \\frac{1}{2b}e^{-\\frac{|t-y|}{b}}` where :math:`b=\\frac{\\sigma}{\\sqrt{2}}`,</span>
<span class="sd">    :math:`y` is the mean and :math:`\\sigma` is the standard deviation.</span>

<span class="sd">    hyp = [ log_sigma ]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyp</span> <span class="o">=</span> <span class="p">[</span> <span class="n">log_sigma</span> <span class="p">]</span>

    <span class="k">def</span> <span class="nf">proceed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">s2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inffunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyp</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="n">sn</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">inffunc</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>                              <span class="c"># prediction mode if inf is not present</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">s2zero</span> <span class="o">=</span> <span class="bp">True</span><span class="p">;</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s2</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">s2zero</span> <span class="o">=</span> <span class="bp">False</span>                       <span class="c"># s2==0?       </span>
            <span class="k">if</span> <span class="n">s2zero</span><span class="p">:</span>                                   <span class="c"># log probability evaluation</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">b</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">);</span> <span class="n">s2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>                                        <span class="c"># prediction</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">EP</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ymu</span> <span class="o">=</span> <span class="n">mu</span>                              <span class="c"># first y moment</span>
                <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">ys2</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">+</span> <span class="n">sn</span><span class="o">**</span><span class="mi">2</span>                  <span class="c"># second y moment</span>
                    <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">ymu</span><span class="p">,</span><span class="n">ys2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">ymu</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lp</span>
        <span class="k">else</span><span class="p">:</span>                                            <span class="c"># inference mode</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inffunc</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">Laplace</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>                          <span class="c"># no derivative mode</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> 
                    <span class="n">ymmu</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">mu</span>
                    <span class="n">lp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ymmu</span><span class="p">)</span><span class="o">/</span><span class="n">b</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>                        <span class="c"># derivative of log likelihood</span>
                        <span class="n">dlp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ymmu</span><span class="p">)</span><span class="o">/</span><span class="n">b</span>
                        <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>                    <span class="c"># 2nd derivative of log likelihood</span>
                            <span class="n">d2lp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ymmu</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>                <span class="c"># 3rd derivative of log likelihood</span>
                                <span class="n">d3lp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ymmu</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span><span class="p">,</span><span class="n">d2lp</span><span class="p">,</span><span class="n">d3lp</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span><span class="p">,</span><span class="n">d2lp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">lp</span><span class="p">,</span><span class="n">dlp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">lp</span>
                <span class="k">else</span><span class="p">:</span>                                    <span class="c"># derivative w.r.t. hypers</span>
                    <span class="n">lp_dhyp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">b</span> <span class="o">-</span> <span class="mi">1</span>           <span class="c"># derivative of log likelihood w.r.t. hypers</span>
                    <span class="n">dlp_dhyp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">mu</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">b</span>              <span class="c"># first derivative,</span>
                    <span class="n">d2lp_dhyp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>         <span class="c"># and also of the second mu derivative</span>
                    <span class="k">return</span> <span class="n">lp_dhyp</span><span class="p">,</span> <span class="n">dlp_dhyp</span><span class="p">,</span> <span class="n">d2lp_dhyp</span>     
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inffunc</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">EP</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span><span class="nb">len</span><span class="p">(</span><span class="n">s2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span><span class="nb">len</span><span class="p">(</span><span class="n">sn</span><span class="o">.</span><span class="n">flatten</span><span class="p">())])</span>
                <span class="n">on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">on</span><span class="p">;</span> <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="n">on</span><span class="p">;</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s2</span><span class="o">*</span><span class="n">on</span><span class="p">;</span> <span class="n">sn</span> <span class="o">=</span> <span class="n">sn</span><span class="o">*</span><span class="n">on</span><span class="p">;</span> 
                <span class="n">fac</span> <span class="o">=</span> <span class="mf">1e3</span><span class="p">;</span>          <span class="c"># factor between the widths of the two distributions ...</span>
                                    <span class="c"># ... from when one considered a delta peak, we use 3 orders of magnitude</span>
                <span class="c">#idlik = np.reshape( (fac*sn) &lt; np.sqrt(s2) , (sn.shape[0],) ) # Likelihood is a delta peak</span>
                <span class="c">#idgau = np.reshape( (fac*np.sqrt(s2)) &lt; sn , (sn.shape[0],) ) # Gaussian is a delta peak</span>
                <span class="n">idlik</span> <span class="o">=</span> <span class="p">(</span><span class="n">fac</span><span class="o">*</span><span class="n">sn</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span> 
                <span class="n">idgau</span> <span class="o">=</span> <span class="p">(</span><span class="n">fac</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">sn</span> 
                <span class="nb">id</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">idgau</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">idlik</span><span class="p">))</span> <span class="c"># interesting case in between</span>

                <span class="k">if</span> <span class="n">der</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>                          <span class="c"># no derivative mode</span>
                    <span class="n">lZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">dlZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">d2lZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">idlik</span><span class="p">):</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="n">Gauss</span><span class="p">(</span><span class="n">log_sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="n">idlik</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">idlik</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">idlik</span><span class="p">])</span>
                        <span class="n">lZ</span><span class="p">[</span><span class="n">idlik</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">dlZ</span><span class="p">[</span><span class="n">idlik</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">d2lZ</span><span class="p">[</span><span class="n">idlik</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">idgau</span><span class="p">):</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="n">Laplace</span><span class="p">(</span><span class="n">log_hyp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="n">idgau</span><span class="p">]))</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">[</span><span class="n">idgau</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">idgau</span><span class="p">])</span>
                        <span class="n">lZ</span><span class="p">[</span><span class="n">idgau</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">dlZ</span><span class="p">[</span><span class="n">idgau</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">d2lZ</span><span class="p">[</span><span class="n">idgau</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> 
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
                        <span class="c"># substitution to obtain unit variance, zero mean Laplacian</span>
                        <span class="n">tvar</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">1e-16</span><span class="p">)</span>
                        <span class="n">tmu</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-16</span><span class="p">)</span>
                        <span class="c"># an implementation based on logphi(t) = log(normcdf(t))</span>
                        <span class="n">zp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmu</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">tvar</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tvar</span><span class="p">)</span>
                        <span class="n">zm</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmu</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">tvar</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tvar</span><span class="p">)</span>
                        <span class="n">ap</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_logphi</span><span class="p">(</span><span class="o">-</span><span class="n">zp</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">tmu</span>
                        <span class="n">am</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_logphi</span><span class="p">(</span> <span class="n">zm</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">tmu</span>
                        <span class="n">apam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">ap</span><span class="p">,</span><span class="n">am</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">lZ</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logsum2exp</span><span class="p">(</span><span class="n">apam</span><span class="p">)</span> <span class="o">+</span> <span class="n">tvar</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">lqp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">zp</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logphi</span><span class="p">(</span><span class="o">-</span><span class="n">zp</span><span class="p">);</span>       <span class="c"># log( N(z)/Phi(z) )</span>
                        <span class="n">lqm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">zm</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logphi</span><span class="p">(</span> <span class="n">zm</span><span class="p">);</span>
                        <span class="n">dap</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lqp</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">]))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
                        <span class="n">dam</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lqm</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">]))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
                        <span class="n">_z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">ap</span><span class="p">,</span><span class="n">am</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">_z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dap</span><span class="p">,</span><span class="n">dam</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">]])</span>
                        <span class="n">dlZ</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expABz_expAx</span><span class="p">(</span><span class="n">_z1</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_z2</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">nargout</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">8.</span><span class="p">)</span><span class="o">/</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">]);</span>
                            <span class="n">bp</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">zp</span><span class="o">/</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lqp</span><span class="p">)</span>
                            <span class="n">bm</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">/</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">zm</span><span class="o">/</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lqm</span><span class="p">)</span>
                            <span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                            <span class="n">_z1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ap</span><span class="p">,</span><span class="n">am</span><span class="p">]),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                            <span class="n">_z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bp</span><span class="p">,</span><span class="n">bm</span><span class="p">]),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                            <span class="n">d2lZ</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expABz_expAx</span><span class="p">(</span><span class="n">_z1</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_z2</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span> <span class="o">-</span> <span class="n">dlZ</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                            <span class="k">return</span> <span class="n">lZ</span><span class="p">,</span><span class="n">dlZ</span><span class="p">,</span><span class="n">d2lZ</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">lZ</span><span class="p">,</span><span class="n">dlZ</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">lZ</span>
                <span class="k">else</span><span class="p">:</span>                                    <span class="c"># derivative mode</span>
                    <span class="n">dlZhyp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">idlik</span><span class="p">):</span>
                        <span class="n">dlZhyp</span><span class="p">[</span><span class="n">idlik</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">idgau</span><span class="p">):</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="n">Laplace</span><span class="p">(</span><span class="n">log_hyp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="n">idgau</span><span class="p">]))</span>
                        <span class="n">a</span> <span class="o">=</span>  <span class="n">l</span><span class="o">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">[</span><span class="n">idgau</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">idgau</span><span class="p">],</span> <span class="n">inffunc</span><span class="o">=</span><span class="s">&#39;inf.Laplace&#39;</span><span class="p">,</span> <span class="n">nargout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">dlZhyp</span><span class="p">[</span><span class="n">idgau</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
                        <span class="c"># substitution to obtain unit variance, zero mean Laplacian</span>
                        <span class="n">tmu</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-16</span><span class="p">);</span>        <span class="n">tvar</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">1e-16</span><span class="p">)</span>
                        <span class="n">zp</span>  <span class="o">=</span> <span class="p">(</span><span class="n">tvar</span><span class="o">+</span><span class="n">tmu</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tvar</span><span class="p">);</span>  <span class="n">vp</span> <span class="o">=</span> <span class="n">tvar</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">tmu</span>
                        <span class="n">zm</span>  <span class="o">=</span> <span class="p">(</span><span class="n">tvar</span><span class="o">-</span><span class="n">tmu</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tvar</span><span class="p">);</span>  <span class="n">vm</span> <span class="o">=</span> <span class="n">tvar</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">tmu</span>
                        <span class="n">dzp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">+</span><span class="n">tmu</span><span class="o">*</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
                        <span class="n">dvp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">tvar</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">tmu</span>
                        <span class="n">dzm</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">-</span><span class="n">tmu</span><span class="o">*</span><span class="n">sn</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
                        <span class="n">dvm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">tvar</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">tmu</span>
                        <span class="n">lezp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lerfc</span><span class="p">(</span><span class="n">zp</span><span class="p">);</span> <span class="c"># ap = exp(vp).*ezp</span>
                        <span class="n">lezm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lerfc</span><span class="p">(</span><span class="n">zm</span><span class="p">);</span> <span class="c"># am = exp(vm).*ezm</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vp</span><span class="o">+</span><span class="n">lezp</span><span class="p">,</span><span class="n">vm</span><span class="o">+</span><span class="n">lezm</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span> <span class="c"># subtract max to avoid numerical pb</span>
                        <span class="n">ep</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">vp</span><span class="o">+</span><span class="n">lezp</span><span class="o">-</span><span class="n">vmax</span><span class="p">)</span>
                        <span class="n">em</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">vm</span><span class="o">+</span><span class="n">lezm</span><span class="o">-</span><span class="n">vmax</span><span class="p">)</span>
                        <span class="n">dap</span> <span class="o">=</span> <span class="n">ep</span><span class="o">*</span><span class="p">(</span><span class="n">dvp</span> <span class="o">-</span> <span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">zp</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">lezp</span><span class="p">)</span><span class="o">*</span><span class="n">dzp</span><span class="p">)</span>
                        <span class="n">dam</span> <span class="o">=</span> <span class="n">em</span><span class="o">*</span><span class="p">(</span><span class="n">dvm</span> <span class="o">-</span> <span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">zm</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">lezm</span><span class="p">)</span><span class="o">*</span><span class="n">dzm</span><span class="p">)</span>        
                        <span class="n">dlZhyp</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dap</span><span class="o">+</span><span class="n">dam</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ep</span><span class="o">+</span><span class="n">em</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>       
                    <span class="k">return</span> <span class="n">dlZhyp</span>               <span class="c"># deriv. wrt hyp.lik</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inffunc</span><span class="p">,</span> <span class="n">inf</span><span class="o">.</span><span class="n">VB</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2</span><span class="o">.</span><span class="n">flatten</span><span class="p">());</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span> <span class="n">z</span> <span class="o">=</span> <span class="n">y</span>
                <span class="k">return</span> <span class="n">b</span><span class="p">,</span><span class="n">z</span>

    <span class="k">def</span> <span class="nf">_lerfc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; numerically safe implementation of f(t) = log(1-erf(t)) = log(erfc(t))&#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erfc</span>
        <span class="n">f</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">tmax</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">t</span><span class="o">&lt;</span><span class="n">tmin</span>                              <span class="c"># log(1-erf(t)) is safe to evaluate</span>
        <span class="n">bd</span> <span class="o">=</span> <span class="n">t</span><span class="o">&gt;</span><span class="n">tmax</span>                              <span class="c"># evaluate tight bound</span>
        <span class="n">nok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
        <span class="n">interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">nok</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span> <span class="c"># interpolate between both of them</span>
        <span class="n">f</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">t</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="p">))</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">12</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span><span class="o">-</span><span class="n">tmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tmax</span><span class="o">-</span><span class="n">tmin</span><span class="p">))</span> <span class="p">))</span>   <span class="c"># interp. weights</span>
        <span class="n">f</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">f</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">erfc</span><span class="p">(</span> <span class="n">t</span><span class="p">[</span><span class="n">interp</span><span class="p">]</span> <span class="p">))</span>
        <span class="n">f</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">erfc</span><span class="p">(</span> <span class="n">t</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="p">))</span>             <span class="c"># safe eval</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">_expABz_expAx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">        Computes y = ( (exp(A).*B)*z ) ./ ( exp(A)*x ) in a numerically safe way</span>
<span class="sd">        The function is not general in the sense that it yields correct values for</span>
<span class="sd">        all types of inputs. We assume that the values are close together.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">maxA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                    <span class="c"># number of columns, max over columns</span>
        <span class="n">maxA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">maxA</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">maxA</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">)))</span>       <span class="c"># subtract maximum value</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="n">B</span><span class="p">),</span><span class="n">z</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">x</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_logphi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Safe implementation of the log of phi(x) = \int_{-\infty}^x N(f|0,1) df</span>
<span class="sd">         returns lp = log(normcdf(z))</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">lp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>                       <span class="c"># allocate memory</span>
        <span class="n">zmin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.2</span><span class="p">;</span> <span class="n">zmax</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.5</span><span class="p">;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">z</span><span class="o">&gt;</span><span class="n">zmax</span>                                 <span class="c"># safe evaluation for large values</span>
        <span class="n">bd</span> <span class="o">=</span> <span class="n">z</span><span class="o">&lt;</span><span class="n">zmin</span>                                 <span class="c"># use asymptotics</span>
        <span class="n">nok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">nok</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span> <span class="c"># interpolate between both of them</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mf">25.</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">-</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">-</span><span class="n">zmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zmax</span><span class="o">-</span><span class="n">zmin</span><span class="p">))</span> <span class="p">))</span>  <span class="c"># interp. weights</span>
        <span class="n">lp</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="mf">1.</span><span class="o">+</span><span class="n">erf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">lp</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">z</span><span class="p">[</span><span class="n">nok</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> 
        <span class="n">lp</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="n">lp</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">+</span> <span class="n">lam</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="mf">1.</span><span class="o">+</span><span class="n">erf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">lp</span>

    <span class="k">def</span> <span class="nf">_logsum2exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">logx</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;computes y = log( sum(exp(x),2) ) in a numerically safe way </span>
<span class="sd">        by subtracting the row maximum to avoid cancelation after taking </span>
<span class="sd">        the exp the sum is done along the rows&#39;&#39;&#39;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">logx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_logx</span> <span class="o">=</span> <span class="n">logx</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">max_logx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">max_logx</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="c"># we have all values in the log domain, and want to calculate a sum</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logx</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">max_logx</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span><span class="p">))))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_logx</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>


 
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Theory.html">GPs &amp; Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Examples.html">Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Kernels.html">Kernels &amp; Means</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Likelihoods.html">Likelihoods &amp; Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Opts.html">Optimizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Develop.html">Developing Customized Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Graph.html">Kernels for Graph Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Default.html">List of Functions and Default Parameters</a></li>
</ul>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pyGPs v1.3 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Marion Neumann, Shan Huang, Daniel Marthaler, Kristian Kersting.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>